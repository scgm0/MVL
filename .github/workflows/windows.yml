name: Build MVL Project for Windows

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    name: ${{ matrix.name }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows-Mono
            cache-name: windows-mono
            bin: ./godot/bin/godot.windows.editor.x86_64.mono.console.exe
            compiler: msvc

    steps:
      - name: Checkout MVL Repository
        uses: actions/checkout@v4
        with:
          path: mvl-repo

      - name: 1.1. Setup Python for SCons
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: 1.2. Install SCons
        run: pip install scons

      - name: 1.3. Install gettext
        shell: powershell
        run: |
          echo "Install gettext..."
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://github.com/vslavik/gettext-tools-windows/releases/download/v0.26/gettext-tools-windows-0.26.zip" -OutFile "gettext-tools-windows.zip"
          Expand-Archive -Path "gettext-tools-windows.zip" -DestinationPath "gettext-tools"
          $GETTEXT_PATH = (Get-Location).Path + "\gettext-tools\bin"
          echo $GETTEXT_PATH | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 2.1. Setup .NET8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 2.2. Setup .NET10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: 3. Download and Setup Vintage Story Clients
        shell: powershell
        run: |
          echo "Setting up Vintage Story environments..."
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://cdn.vintagestory.at/gamefiles/stable/vs_client_linux-x64_1.21.5.tar.gz" -OutFile "vs_client_net8.tar.gz"
          New-Item -ItemType Directory -Force -Path NET8
          tar -xzf vs_client_net8.tar.gz -C NET8
          echo "VINTAGE_STORY_NET8=$((Get-Location).Path)\NET8\vintagestory" >> $env:GITHUB_ENV

          Invoke-WebRequest -Uri "https://cdn.vintagestory.at/gamefiles/stable/vs_client_linux-x64_1.20.9.tar.gz" -OutFile "vs_client_net7.tar.gz"
          New-Item -ItemType Directory -Force -Path NET7
          tar -xzf vs_client_net7.tar.gz -C NET7
          echo "VINTAGE_STORY_NET7=$((Get-Location).Path)\NET7\vintagestory" >> $env:GITHUB_ENV

          echo "Vintage Story paths set."

      - name: 4.1. Clone Godot
        run: git clone https://github.com/scgm0/godot.git --branch Fix-RenderingDevice-Opengl3

      - name: 4.2. Restore Godot build cache
        uses: ./mvl-repo/.github/actions/godot-cache-restore
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: 4.3 Download Direct3D 12 SDK components
        run: python ./godot/misc/scripts/install_d3d12_sdk_windows.py

      - name: 4.4 Download pre-built ANGLE static libraries
        uses: dsaltares/fetch-gh-release-asset@1.1.2
        with:
          repo: godotengine/godot-angle-static
          version: tags/chromium/6601.2
          file: godot-angle-static-x86_64-${{ matrix.compiler == 'gcc' && 'gcc' || 'msvc' }}-release.zip
          target: angle/angle.zip

      - name: 4.5 Extract pre-built ANGLE static libraries
        run: Expand-Archive -Force angle/angle.zip ${{ github.workspace }}/

      - name: 4.6 Compilation Editor
        uses: ./mvl-repo/.github/actions/godot-build
        with:
          scons-flags: >-
            vsc=yes
            module_mono_enabled=yes
            accesskit=no
            disable_xr=yes
            d3d12=yes
            "angle_libs=${{ github.workspace }}/"
          platform: windows
          target: editor

      - name: 4.7 Compilation Release Template
        uses: ./mvl-repo/.github/actions/godot-build
        with:
          scons-flags: >-
            lto=full
            production=yes
            vsc=yes
            optimize=size
            disable_3d=yes
            disable_xr=yes
            disable_navigation_2d=yes
            disable_navigation_3d=yes
            disable_physics_2d=yes
            disable_physics_3d=yes
            disable_overrides=no
            disable_advanced_gui=no
            speechd=no
            fast_unsafe=yes
            minizip=no
            xaudio2=no
            pulseaudio=no
            accesskit=no
            vulkan=yes
            sdl=no
            alsa=no
            debug_symbols=no
            brotli=no
            d3d12=yes
            "angle_libs=${{ github.workspace }}/"
            module_basis_universal_enabled=no
            module_bmp_enabled=no
            module_camera_enabled=no
            module_csg_enabled=no
            module_dds_enabled=no
            module_enet_enabled=no
            module_fbx_enabled=no
            module_gltf_enabled=no
            module_godot_physics_2d_enabled=no
            module_godot_physics_3d_enabled=no
            module_gridmap_enabled=no
            module_hdr_enabled=no
            module_interactive_music_enabled=no
            module_jsonrpc_enabled=no
            module_ktx_enabled=no
            module_jolt_physics_enabled=no
            module_lightmapper_rd_enabled=no
            module_mbedtls_enabled=no
            module_meshoptimizer_enabled=no
            module_minimp3_enabled=no
            module_mobile_vr_enabled=no
            module_mono_enabled=yes
            module_multiplayer_enabled=no
            module_navigation_enabled=no
            module_noise_enabled=no
            module_ogg_enabled=no
            module_openxr_enabled=no
            module_raycast_enabled=no
            module_regex_enabled=no
            module_squish_enabled=no
            module_tga_enabled=no
            module_theora_enabled=no
            module_upnp_enabled=no
            module_vhacd_enabled=no
            module_vorbis_enabled=no
            module_webrtc_enabled=no
            module_websocket_enabled=no
            module_webxr_enabled=no
            module_zip_enabled=no
          platform: windows
          target: template_release

      - name: 4.8. Save Godot build cache
        uses: ./mvl-repo/.github/actions/godot-cache-save
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: 4.9 Generate C# glue
        shell: powershell
        run: |
          & ${{ matrix.bin }} --headless --generate-mono-glue ./godot/modules/mono/glue
          python ./godot/modules/mono/build_scripts/build_assemblies.py --godot-output-dir=./godot/bin --push-nupkgs-local ./godot/bin/GodotSharp/Tools/nupkgs --godot-platform=windows
          dotnet nuget add source "$((Get-Location).Path)\godot\bin\GodotSharp\Tools\nupkgs"

      - name: 5. Build and Export MVL Project
        run: |
          echo "Building MVL solution..."
          dotnet build mvl-repo/MVL

          echo "Importing assets with Godot..."
          ${{ matrix.bin }} --path mvl-repo/MVL --import --headless

          echo "Exporting project..."
          $ReleaseTemplatePath = "$((Get-Location).Path)\godot\bin\godot.windows.template_release.x86_64.mono.exe".Replace("\", "/")
          $ExportPreset = @"
          [preset.0]

          name="Windows Desktop"
          platform="Windows Desktop"
          runnable=true
          dedicated_server=false
          custom_features=""
          export_filter="all_resources"
          include_filter="Misc/*"
          exclude_filter="Assets/Icon/MD/icons.json"
          export_path="../../export_build/windows/MVL.exe"
          patches=PackedStringArray()
          encryption_include_filters=""
          encryption_exclude_filters=""
          seed=0
          encrypt_pck=false
          encrypt_directory=false
          script_export_mode=2

          [preset.0.options]

          custom_template/debug=""
          custom_template/release="$ReleaseTemplatePath"
          debug/export_console_wrapper=1
          binary_format/embed_pck=true
          texture_format/s3tc_bptc=true
          texture_format/etc2_astc=false
          shader_baker/enabled=false
          binary_format/architecture="x86_64"
          codesign/enable=false
          codesign/timestamp=true
          codesign/timestamp_server_url=""
          codesign/digest_algorithm=1
          codesign/description=""
          codesign/custom_options=PackedStringArray()
          application/modify_resources=true
          application/icon=""
          application/console_wrapper_icon=""
          application/icon_interpolation=4
          application/file_version=""
          application/product_version=""
          application/company_name=""
          application/product_name="神麤詭末的复古物语启动器"
          application/file_description="一个开源的复古物语启动器"
          application/copyright=""
          application/trademarks=""
          application/export_angle=0
          application/export_d3d12=1
          application/d3d12_agility_sdk_multiarch=false
          dotnet/include_scripts_content=false
          dotnet/include_debug_symbols=false
          dotnet/embed_build_outputs=true
          "@
          $ExportPreset | Set-Content -Path "mvl-repo/MVL/export_presets.cfg"
          echo "Content of export_presets.cfg:"
          Get-Content -Path "mvl-repo/MVL/export_presets.cfg"

          New-Item -ItemType Directory -Force -Path "export_build"
          New-Item -ItemType Directory -Force -Path "export_build/windows"

          ${{ matrix.bin }} --path mvl-repo/MVL --headless --export-release "Windows Desktop" "$((Get-Location).Path)\export_build\windows\MVL.exe"

          echo "Export finished."

      - name: 6. Upload Windows Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MVL-Windows-Build
          path: export_build/windows/MVL.exe
